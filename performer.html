<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Performer</title>
        <script src="phaser.min.js"></script>
        <script src="utilities.js"></script>
    </head>
    <body>

    <script type="text/javascript">
    /* global Phaser */
    /* global getAllUrlParams */
    /* global DrawGrid */
    /* global DrawIconPalette */
    /* global PlaceEventIcon */
    /* global getCurrentTime */
    /* global determinePartNumberFromY */
    /* global convertYToPercentageInPart */
    /* global convertEventYToAbsoluteY */
    (function() { // Begin scoping function
    var debug = false;
    var homeBaseUrl = "http://ec2-52-36-206-120.us-west-2.compute.amazonaws.com:4747";
    var partNumber = 0;
    var LastEventIdProcessed = 0.0;
    var globals;
    window.onload = function() {
        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', 
                { create: create });
        
        function create () {
            
            game.load.onLoadComplete.add(loadComplete, this);
    
            game.time.events.repeat(Phaser.Timer.SECOND, 1000000000, GetGlobalEvent, this);
            game.stage.backgroundColor = "0800ff";
            game.stage.disableVisibilityChange = true;
            
            game.input.onDown.add(IconPlaced, this);
            
            var partIdentifier = getAllUrlParams().part;
            if (typeof partIdentifier == 'undefined'){
                partIdentifier = "score";
            }
            var score = "score";
            if (partIdentifier.valueOf() == score.valueOf())
            { // If this is the SCORE version of Perfoamer
                partNumber = 0;
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        globals = JSON.parse(xhr.responseText);
                        game.debug.text( "parts = "+globals.parts, 100, 280 );
                        DrawGrid(game,globals.parts);
                        for (let i = 0; i < globals.icons.length; i++) {
                           game.load.image(globals.icons[i].name,'Images/'+globals.icons[i].fileName);
                        }
                         game.load.start();
                    }
                };
                xhr.open('GET', homeBaseUrl + "/globals", true);
                xhr.send(null);
            }else{
                xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        globals = JSON.parse(xhr.responseText);
                        game.debug.text( "parts = "+globals.parts, 100, 280 );
                        DrawGrid(game,globals.parts);
                        for (let i = 0; i < globals.icons.length; i++) {
                           game.load.image(globals.icons[i].name,'Images/'+globals.icons[i].fileName);
                        }
                         game.load.start();
                    }
                };
                xhr.open('GET', homeBaseUrl + "/globals", true);
                xhr.send(null);
                partNumber = Number(partIdentifier);
                DrawGrid(game,0);  // just one part
            }
            
            function loadComplete() {
                if (partNumber<1){
                    DrawIconPalette(game,globals);
                }
            }
            
            function GetGlobalEvent() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var event = JSON.parse(xhr.responseText);
                        if (event.id > LastEventIdProcessed){
                            LastEventIdProcessed=event.id;
                            if (debug==true){
                                game.debug.text("name="+event.icon+"["+event.x+","+event.y+"] Part :" + event.part, 100, 400 );
                            }
                            var y = 0;
                            if (partNumber<1){ //showing score
                                if (debug == true){
                                    game.debug.text( "SCORE", 100, 100 );
                                }
                                y = convertEventYToAbsoluteY(event.y,event.part, globals.parts, game.height);
                                if (debug==true){
                                    game.debug.text("converted y = "+ y, 100,600);
                                }
                               PlaceEventIcon(game,event.icon,event.x,y);
                            }else{ // showing single part
                                if (event.part==partNumber){
                                    y = event.y * game.height;
                                    PlaceEventIcon(game,event.icon,event.x,y);
                                }
                                if (debug == true){
                                    game.debug.text( "PART "+ partNumber, 100, 100 );
                                }
                            }
                        }
                    }
                };
                var timeValue=getCurrentTime();
                xhr.open('GET', homeBaseUrl + "/getEvents", true);
                xhr.send(null);
            }   
            
        }
    
        function IconPlaced(pointer) {
            var X = pointer.x;
            var Y = pointer.y;
      
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                } 
            };
            var convertedY = convertYToPercentageInPart(Y,globals.parts,game.height);
            var placedPart = determinePartNumberFromY(Y,globals.parts,game.height);
            var reportUrl = homeBaseUrl 
                + "/newEvent?x="+ X + "&y=" + convertedY + "&part=" + placedPart + "&icon=" + "eighthNotes";
            xhr.open('GET',reportUrl , true);
            xhr.send(null);
        }
        
            
    };
    })();         // End scoping function
    </script>

    </body>
</html>