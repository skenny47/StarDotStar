<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Performer</title>
        <script src="phaser.min.js"></script>
        <script src="utilities.js"></script>
    </head>
    <body>

    <script type="text/javascript">
    /* global Phaser */
    /* global getAllUrlParams */
    /* global DrawGrid */
    /* global PlaceEventIcon */
    (function() { // Begin scoping function
    
    var homeBaseUrl = "http://ec2-52-36-206-120.us-west-2.compute.amazonaws.com:4747";
    window.onload = function() {
        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', 
                { preload: preload, create: create, update: update });
        function preload () {
           
            game.load.image('eighthNotes',  'Images/icons8-music-50.png');
            
        }
        
        function create () {
                   // game.debug.text( "foobar", 100, 280 );
            game.time.events.repeat(Phaser.Timer.SECOND/2, 1000000000, ReceiveGlobalEvents, this);
            game.stage.backgroundColor = "0800ff";
           
            // Establish 'score' as the default
            var score = "score";
            var partNumber = getAllUrlParams().part;
            if (typeof partNumber == 'undefined'){
                partNumber = "score";
            }
            
            if (partNumber.valueOf() == score.valueOf())
            {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        //alert(xhr.responseText);
                        var globals = JSON.parse(xhr.responseText);
                        var parts = globals.parts;
                        game.debug.text( "parts = "+parts, 100, 280 );
                        DrawGrid(game,parts);
                    }
                };
                xhr.open('GET', homeBaseUrl + "/globals", true);
                xhr.send(null);
            }else{
                DrawGrid(game,0);
            }
            
            function ReceiveGlobalEvents() {
                var x = game.rnd.integerInRange(0, game.width);
                var y = game.rnd.integerInRange(0, game.height);
                //game.debug.text( "x,y = "+x+","+y, 100, 280 );
               // PlaceEventIcon(game,'eighthNotes',x,y);
                
            }
            
        }
        
        function update() {
            if (game.input.activePointer.isDown)
            {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        
                    } 
                };
                var reportUrl = homeBaseUrl 
                    + "/newEvent?x="+game.input.x
                    + "&y=" +game.input.y
                    + "&icon="
                    + "eighthNotes";
                xhr.open('GET',reportUrl , true);
                xhr.send(null);
            }
        }
            
    };
    })();         // End scoping function
    </script>

    </body>
</html>