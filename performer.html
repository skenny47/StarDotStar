<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Performer</title>
        <script src="phaser.min.js"></script>
        <script src="utilities.js"></script>
    </head>
    <body>

    <script type="text/javascript">
    /* global Phaser */
    /* global getAllUrlParams */
    /* global DrawGrid */
    /* global PlaceEventIcon */
    /* global getCurrentTime */
    (function() { // Begin scoping function
    
    var homeBaseUrl = "http://ec2-52-36-206-120.us-west-2.compute.amazonaws.com:4747";
    var X;
    var Y;
    window.onload = function() {
        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', 
                { preload: preload, create: create /*, update: update*/  });
        function preload () {
           
            game.load.image('eighthNotes',  'Images/icons8-music-50.png');
            
        }
        
        function create () {
                   // game.debug.text( "foobar", 100, 280 );
            game.time.events.repeat(Phaser.Timer.SECOND, 1000000000, ReceiveGlobalEvents, this);
            game.stage.backgroundColor = "0800ff";
           
           game.input.onDown.add(IconPlaced, this);
         
            // Establish 'score' as the default
            var score = "score";
            var partIdentifier = getAllUrlParams().part;
            if (typeof partNumber == 'undefined'){
                partIdentifier = "score";
            }
            
            if (partIdentifier.valueOf() == score.valueOf())
            { // If this is the SCORE version of Perfoamer
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var globals = JSON.parse(xhr.responseText);
                        var numberOfParts = globals.parts;
                        game.debug.text( "parts = "+numberOfParts, 100, 280 );
                        DrawGrid(game,numberOfParts);
                    }
                };
                xhr.open('GET', homeBaseUrl + "/globals", true);
                xhr.send(null);
            }else{
                DrawGrid(game,0);
            }
            
            function ReceiveGlobalEvents() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var event = JSON.parse(xhr.responseText);
                       // var events = JSON.parse(xhr.responseText);
                        //events.forEach(event => {
                            game.debug.text("name="+event.name+"["+event.x+","+event.y+"]", 100, 400 );
                            PlaceEventIcon(game,event.name,event.x,event.y);
                        //});
                    }
                };
                var timeValue=getCurrentTime();
                //xhr.open('GET', homeBaseUrl + "/getEvents?t="+timeValue, true);
                xhr.open('GET', homeBaseUrl + "/getEvents?t=foobar", true);
                xhr.send(null);
              
                
            }
            
        }
        
        
        function IconPlaced(pointer) {
            X = pointer.x;
            Y = pointer.y;
      
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    
                } 
            };
            var reportUrl = homeBaseUrl 
                + "/newEvent?x="+ X + "&y=" + Y + "&icon=" + "eighthNotes";
            xhr.open('GET',reportUrl , true);
            xhr.send(null);
        }
            
    };
    })();         // End scoping function
    </script>

    </body>
</html>